datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  users     User[]
  
  ownershipRules OwnershipRule[]
  customers Customer[]
  orders    Order[]
  products  Product[]
  requests  Request[]
  policies  Policy[]
  auditLogs AuditLog[]
  businessHours BusinessHours[]
  holidays  Holiday[]
  calendarEvents CalendarEvent[]
  oauthCredentials OAuthCredential[]
  billingBatches BillingBatch[]
  inboundShipments InboundShipment[]
  settings  Settings[]
  wooStores WooStore[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id            String   @id @default(uuid())
  tenantId      String
  email         String   @unique
  passwordHash  String
  role          String
  twofaSecret   String?
  twofaEnabled  Boolean  @default(false)
  lastLoginAt   DateTime?
  failedAttempts Int     @default(0)
  lockedUntil   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  sessions      Session[]
  auditLogs     AuditLog[]
  requests      Request[]
  requestComments RequestComment[]
}

model Session {
  id          String   @id @default(uuid())
  userId      String
  token       String   @unique
  fingerprint String?
  ipAddress   String?
  userAgent   String?
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([token])
  @@index([userId])
}


model OwnershipRule {
  id             String  @id @default(uuid())
  tenantId       String
  entityType     String
  priority       Int
  conditionsJson Json
  actionJson     Json
  active         Boolean @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  tenant         Tenant @relation(fields: [tenantId], references: [id])
  
  @@index([tenantId, entityType, priority])
}

model Policy {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  modules     Json     // {orders: true, shipments: true, ...}
  actions     Json     // {allowDownloadLabels: true, ...}
  dataScope   Json     // {allowedStatuses: [], ...}
  piiSettings Json     // {maskEmail: true, ...}
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  @@unique([tenantId, name])
}

model EntityMap {
  id         String @id @default(uuid())
  entityType String
  blId       String
  tenantId   String
  customerId String?
  createdAt  DateTime @default(now())

  @@unique([entityType, blId])
  @@index([tenantId])
}

// Generic mapping for remote provider entities (provider-agnostic)
model RemoteEntityMap {
  id         String   @id @default(uuid())
  tenantId   String
  storeId    String
  provider   String   // 'woocommerce'
  entityType String   // 'order' | 'product' | 'customer' | ...
  remoteId   String
  localType  String   // maps to local table type
  localId    String
  createdAt  DateTime @default(now())

  @@unique([storeId, entityType, remoteId])
  @@index([tenantId, provider, entityType])
}

model Customer {
  id             String   @id @default(uuid())
  tenantId       String
  email          String?
  emailNormalized String?
  phoneE164      String?
  name           String?
  company        String?
  vatId          String?
  addressLine1   String?
  addressLine2   String?
  city           String?
  state          String?
  postalCode     String?
  country        String?
  notes          String?
  tags           String[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  tenant         Tenant   @relation(fields: [tenantId], references: [id])
  orders         Order[]

  @@unique([tenantId, emailNormalized])
  @@index([tenantId, phoneE164])
}

model Order {
  id             String   @id @default(uuid())
  tenantId       String
  customerId     String?
  
  orderNo        Int?
  blOrderId      String
  externalOrderNo String?
  orderSource    String?
  status         String?
  mappedStatus   String?
  total          Decimal? @db.Decimal(14,2)
  currency       String?
  customerEmail  String?
  customerPhone  String?
  shippingAddress Json?
  billingAddress Json?
  paymentMethod  String?
  notes          String?
  tags           String[]
  confirmedAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  tenant         Tenant   @relation(fields: [tenantId], references: [id])
  customer       Customer? @relation(fields: [customerId], references: [id])
  
  items          OrderItem[]
  shipments      Shipment[]
  returns        Return[]
  invoices       Invoice[]
  serviceCharges OrderServiceCharge[]

  @@index([tenantId, blOrderId])
  @@unique([tenantId, orderNo])
  @@index([tenantId, status, confirmedAt])
  @@index([tenantId, customerEmail])
  @@index([tenantId, externalOrderNo])
}

model OrderItem {
  id      String  @id @default(uuid())
  orderId String
  sku     String?
  name    String?
  qty     Int
  price   Decimal? @db.Decimal(14,2)
  order   Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@index([orderId])
}

model Shipment {
  id          String   @id @default(uuid())
  orderId     String
  blPackageId String?
  carrier     String?
  trackingNo  String?
  status      String?
  labelUrl    String?
  protocolUrl String?
  weight      Decimal? @db.Decimal(10,3)
  dimensions  Json?
  shippedAt   DateTime?
  deliveredAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  order       Order    @relation(fields: [orderId], references: [id])
  
  @@index([trackingNo])
  @@index([orderId])
}

model Product {
  id          String   @id @default(uuid())
  tenantId    String
  sku         String
  name        String?
  description String?
  price       Decimal? @db.Decimal(14,2)
  stock       Int?
  weight      Decimal? @db.Decimal(10,3)
  dimensions  Json?
  images      String[]
  tags        String[]
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  inboundItems InboundItem[]
  stockMovements StockMovement[]

  @@unique([tenantId, sku])
  @@index([tenantId, active])
}

model Invoice {
  id         String   @id @default(uuid())
  orderId    String
  number     String?
  series     String?
  currency   String?
  total      Decimal? @db.Decimal(14,2)
  taxAmount  Decimal? @db.Decimal(14,2)
  pdfUrl     String?
  issuedAt   DateTime?
  dueAt      DateTime?
  paidAt     DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  order      Order    @relation(fields: [orderId], references: [id])
  billingItems BillingBatchItem[]
  
  @@index([orderId])
  @@index([number])
}

model Return {
  id          String   @id @default(uuid())
  orderId     String
  blReturnId  String?
  status      String?
  reason      String?
  notes       String?
  refundAmount Decimal? @db.Decimal(14,2)
  items       Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  order       Order    @relation(fields: [orderId], references: [id])
  photos      ReturnPhoto[]
  notifications ReturnNotification[]
  
  @@index([orderId])
}

model ReturnPhoto {
  id        String   @id @default(uuid())
  returnId  String
  fileUrl   String
  note      String?
  createdAt DateTime @default(now())
  return    Return   @relation(fields: [returnId], references: [id], onDelete: Cascade)

  @@index([returnId])
}

model ReturnNotification {
  id        String   @id @default(uuid())
  returnId  String
  channel   String   // email, sms, web
  subject   String?
  message   String?
  sentAt    DateTime @default(now())
  return    Return   @relation(fields: [returnId], references: [id], onDelete: Cascade)

  @@index([returnId])
}

// Order service charges (admin-set line items for billing)
model OrderServiceCharge {
  id        String   @id @default(uuid())
  orderId   String
  type      String
  amount    Decimal  @db.Decimal(14,2)
  currency  String   @default("TRY")
  notes     String?
  createdAt DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

// Business hours per tenant
model BusinessHours {
  id        String   @id @default(uuid())
  tenantId  String
  weekday   Int      // 0=Sun .. 6=Sat
  startTime String   // HH:mm
  endTime   String   // HH:mm
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, weekday])
}

// Holidays per tenant
model Holiday {
  id        String   @id @default(uuid())
  tenantId  String
  date      DateTime
  name      String
  createdAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, date])
  @@index([tenantId, date])
}

// Calendar events (admin editable, customer read-only)
model CalendarEvent {
  id        String   @id @default(uuid())
  tenantId  String
  title     String
  description String?
  type      String   @default("general")
  startAt   DateTime
  endAt     DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId, startAt])
}

// OAuth credentials (e.g., Google Calendar) - encrypted payload stored as JSON
model OAuthCredential {
  id         String   @id @default(uuid())
  tenantId   String
  provider   String   // 'google_calendar'
  secret     Json     // encrypted payload from EncryptionService
  keyVersion Int      @default(1)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  tenant     Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, provider])
}

// WooCommerce store connection per tenant
model WooStore {
  id             String   @id @default(uuid())
  tenantId       String
  name           String
  baseUrl        String   // https://shop.example.com
  consumerKey    String
  consumerSecret String
  apiVersion     String   @default("v3")
  webhookSecret  String?
  active         Boolean  @default(true)
  lastSync       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, active])
}

// Billing batch for semi-manual invoicing
model BillingBatch {
  id         String   @id @default(uuid())
  tenantId   String
  periodFrom DateTime?
  periodTo   DateTime?
  status     String   @default("created") // created, issued, archived
  total      Decimal? @db.Decimal(14,2)
  createdAt  DateTime @default(now())
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  items      BillingBatchItem[]

  @@index([tenantId, createdAt])
}

model BillingBatchItem {
  id        String   @id @default(uuid())
  batchId   String
  invoiceId String
  amount    Decimal  @db.Decimal(14,2)
  createdAt DateTime @default(now())
  batch     BillingBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  invoice   Invoice      @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([batchId])
  @@index([invoiceId])
}

// Inbound shipments for warehouse receiving
model InboundShipment {
  id        String   @id @default(uuid())
  tenantId  String
  reference String?
  status    String   @default("created") // created, received, cancelled
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  items     InboundItem[]

  @@index([tenantId, createdAt])
}

model InboundItem {
  id        String   @id @default(uuid())
  inboundId String
  productId String?
  sku       String?
  name      String?
  quantity  Int
  createdAt DateTime @default(now())
  inbound   InboundShipment @relation(fields: [inboundId], references: [id], onDelete: Cascade)
  product   Product? @relation(fields: [productId], references: [id])

  @@index([inboundId])
  @@index([productId])
}

model StockMovement {
  id        String   @id @default(uuid())
  productId String
  type      String   // INBOUND, ADJUSTMENT, RETURN
  quantity  Int
  relatedId String?
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, createdAt])
}

// Requests & Approvals System
model Request {
  id           String   @id @default(uuid())
  tenantId     String
  customerId   String?
  createdBy    String
  type         String   // STOCK_ADJUSTMENT, NEW_PRODUCT, ORDER_NOTE, DOCUMENT_UPLOAD, OTHER
  status       String   // DRAFT, SUBMITTED, UNDER_REVIEW, APPROVED, REJECTED, APPLIED
  priority     String   @default("normal") // low, normal, high, critical
  payload      Json
  reviewerUserId String?
  reviewedAt   DateTime?
  appliedAt    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  creator      User     @relation(fields: [createdBy], references: [id])
  comments     RequestComment[]
  attachments  RequestAttachment[]
  
  @@index([tenantId, status, createdAt])
  @@index([createdBy])
}

model RequestComment {
  id        String   @id @default(uuid())
  requestId String
  authorId  String
  message   String
  isInternal Boolean @default(false)
  createdAt DateTime @default(now())
  request   Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)
  author    User     @relation(fields: [authorId], references: [id])
  
  @@index([requestId])
}

model RequestAttachment {
  id        String   @id @default(uuid())
  requestId String
  fileName  String
  fileUrl   String
  mimeType  String?
  fileSize  Int?
  createdAt DateTime @default(now())
  request   Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  @@index([requestId])
}

// Audit Log
model AuditLog {
  id          String   @id @default(uuid())
  tenantId    String?
  userId      String?
  action      String
  entityType  String?
  entityId    String?
  changes     Json?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  tenant      Tenant?  @relation(fields: [tenantId], references: [id])
  user        User?    @relation(fields: [userId], references: [id])
  
  @@index([tenantId, createdAt])
  @@index([userId, createdAt])
  @@index([action, createdAt])
}

// Sync State
model SyncState {
  id          String   @id @default(uuid())
  accountId   String
  entityType  String
  lastSyncAt  DateTime
  checkpoint  Json?
  status      String   @default("idle") // idle, running, failed
  error       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([accountId, entityType])
  @@index([status])
}

// Ingested webhook events
model WebhookEvent {
  id         String   @id @default(uuid())
  tenantId   String
  storeId    String
  provider   String   // 'woocommerce'
  topic      String
  signature  String?
  payload    Json
  status     String   @default("received") // received, processed, failed
  attempts   Int      @default(0)
  error      String?
  createdAt  DateTime @default(now())
  processedAt DateTime?

  @@index([tenantId, storeId, topic, status])
}

// JWT Keys for RS256 (persistence and rotation)
model JwtKey {
  id         String   @id @default(uuid())
  kid        String   @unique
  alg        String
  publicJwk  Json
  privatePem String?
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  rotatedAt  DateTime?
  expiresAt  DateTime?

  @@index([active, createdAt])
}

model Settings {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category  String   // email, baselinker, notification, general
  key       String   // smtp_host, smtp_port, baselinker_api_key, etc.
  value     String?  // encrypted value for sensitive data
  isSecret  Boolean  @default(false) // whether the value should be encrypted
  metadata  Json?    // additional configuration
  updatedBy String?
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@unique([tenantId, category, key])
  @@index([tenantId, category])
}