#!/bin/bash
LOG_FILE="/var/log/git-auto-sync.log"
BACKUP_DIR="/opt/fulexo/server-configs"

cd /opt/fulexo

echo "$(date): Auto-sync baÅŸlatÄ±ldÄ±" >> $LOG_FILE

# GÃ¼ncel sistem bilgilerini gÃ¼ncelle
echo "Sistem bilgileri gÃ¼ncelleniyor..." >> $LOG_FILE

# Database backup
cd /opt/fulexo/compose
docker compose --env-file /etc/fulexo/fulexo.env exec postgres pg_dump -U fulexo_user fulexo > ../server-configs/databases/fulexo-db-backup-$(date +%Y%m%d-%H%M).sql 2>/dev/null
cd /opt/fulexo

# Sistem durumunu gÃ¼ncelle
uname -a > server-configs/system-info.txt
df -h >> server-configs/system-info.txt
free -h >> server-configs/system-info.txt
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" > server-configs/docker-status.txt

# Git deÄŸiÅŸikliklerini kontrol et
if [[ -n $(git status --porcelain) ]]; then
    echo "$(date): DeÄŸiÅŸiklikler tespit edildi, senkronizasyon baÅŸlatÄ±lÄ±yor..." >> $LOG_FILE
    
    git add .
    git commit -m "ðŸ¤– Auto-sync: $(date '+%Y-%m-%d %H:%M:%S')

- Updated system info and docker status
- Database backup: $(date '+%Y%m%d-%H%M')
- Auto-generated by cron job"

    git push origin main
    
    if [ $? -eq 0 ]; then
        echo "$(date): Senkronizasyon tamamlandÄ± âœ…" >> $LOG_FILE
    else
        echo "$(date): Senkronizasyon hatasÄ± âŒ" >> $LOG_FILE
    fi
else
    echo "$(date): DeÄŸiÅŸiklik yok, senkronizasyon atlandÄ±" >> $LOG_FILE
fi

# Eski backup'larÄ± temizle (7 gÃ¼nden eski)
find server-configs/databases/ -name "*.sql" -mtime +7 -delete 2>/dev/null

echo "$(date): Auto-sync tamamlandÄ±" >> $LOG_FILE
