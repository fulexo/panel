#!/bin/bash
LOG_FILE="/var/log/git-auto-sync.log"
BACKUP_DIR="/opt/fulexo/server-configs"

cd /opt/fulexo

echo "$(date): Auto-sync baÅŸlatÄ±ldÄ± (Ä°ki yÃ¶nlÃ¼)" >> $LOG_FILE

# Ã–NCE GitHub'dan gÃ¼ncellemeleri Ã§ek
echo "$(date): GitHub'dan gÃ¼ncellemeler kontrol ediliyor..." >> $LOG_FILE
git fetch origin main

# Remote'da deÄŸiÅŸiklik var mÄ± kontrol et
LOCAL=$(git rev-parse HEAD)
REMOTE=$(git rev-parse origin/main)

if [ "$LOCAL" != "$REMOTE" ]; then
    echo "$(date): GitHub'da yeni deÄŸiÅŸiklikler bulundu, Ã§ekiliyor..." >> $LOG_FILE
    git pull origin main
    
    # Docker servislerini yeniden baÅŸlat (eÄŸer Docker dosyalarÄ± deÄŸiÅŸtiyse)
    if git diff --name-only HEAD~1 | grep -q "compose\|Dockerfile"; then
        echo "$(date): Docker dosyalarÄ± deÄŸiÅŸti, servisler yeniden baÅŸlatÄ±lÄ±yor..." >> $LOG_FILE
        cd /opt/fulexo/compose
        docker compose --env-file /etc/fulexo/fulexo.env up -d --build 2>/dev/null
        cd /opt/fulexo
        echo "$(date): Docker servisleri gÃ¼ncellendi" >> $LOG_FILE
    fi
else
    echo "$(date): GitHub'da yeni deÄŸiÅŸiklik yok" >> $LOG_FILE
fi

# GÃ¼ncel sistem bilgilerini gÃ¼ncelle
echo "$(date): Sistem bilgileri gÃ¼ncelleniyor..." >> $LOG_FILE

# Database backup
cd /opt/fulexo/compose
docker compose --env-file /etc/fulexo/fulexo.env exec postgres pg_dump -U fulexo_user fulexo > ../server-configs/databases/fulexo-db-backup-$(date +%Y%m%d-%H%M).sql 2>/dev/null
cd /opt/fulexo

# Sistem durumunu gÃ¼ncelle
uname -a > server-configs/system-info.txt
df -h >> server-configs/system-info.txt
free -h >> server-configs/system-info.txt
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" > server-configs/docker-status.txt

# SONRA local deÄŸiÅŸiklikleri push et
if [[ -n $(git status --porcelain) ]]; then
    echo "$(date): Local deÄŸiÅŸiklikler tespit edildi, GitHub'a gÃ¶nderiliyor..." >> $LOG_FILE
    
    git add .
    git commit -m "ðŸ¤– Auto-sync: $(date '+%Y-%m-%d %H:%M:%S')

- Updated system info and docker status
- Database backup: $(date '+%Y%m%d-%H%M')
- Auto-generated by cron job"

    git push origin main
    
    if [ $? -eq 0 ]; then
        echo "$(date): Local deÄŸiÅŸiklikler GitHub'a gÃ¶nderildi âœ…" >> $LOG_FILE
    else
        echo "$(date): GitHub push hatasÄ± âŒ" >> $LOG_FILE
    fi
else
    echo "$(date): Local deÄŸiÅŸiklik yok" >> $LOG_FILE
fi

# Eski backup'larÄ± temizle (7 gÃ¼nden eski)
find server-configs/databases/ -name "*.sql" -mtime +7 -delete 2>/dev/null

echo "$(date): Ä°ki yÃ¶nlÃ¼ auto-sync tamamlandÄ±" >> $LOG_FILE
echo "----------------------------------------" >> $LOG_FILE
